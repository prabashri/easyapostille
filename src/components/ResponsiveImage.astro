---
import imageMetadataJson from '../data/image-format-details.json';
import { registerPreloadImage } from '../utils/preloadRegistry';
import { siteDefaults } from '../config/siteDefaults';

interface Props {
  src: string;
  alt: string;
  width?: string | number;
  height?: number;
  title?: string;
  className?: string;
  imageClassName?: string;
  caption?: string;
  loading?: 'lazy' | 'eager';
  sizes?: string;
  breakpoints?: { mobile?: number; tablet?: number; desktop?: number };
  objectFit?: 'cover' | 'contain' | 'fill' | 'none' | 'scale-down';
}

const {
  src,
  alt,
  title,
  className = '',
  imageClassName = 'inline-image',
  objectFit = 'cover',
  caption,
  loading = 'lazy',
  sizes,
  breakpoints,
  height,
  width
} = Astro.props as Props;

const mobileMax = siteDefaults.breakpoints.mobileMax ?? 768;
const desktopMin = siteDefaults.breakpoints.desktopMin ?? 769;

const fetchPriority = loading === 'eager' ? 'high' : undefined;
const metadata = imageMetadataJson as Record<string, any>;
const data = metadata[src];

let hasData = !!data;
let targetWidth = breakpoints?.desktop ?? (typeof width === 'number' ? width : 320);
let aspectRatio = '1/1';

let basePath = '';
let availableWidths: number[] = [];
let defaultAspect = '';
let formats: string[] = [];
let sizesAttr = sizes;
let width1x = targetWidth;
let width2x = targetWidth * 2;
let imageBaseName = '';
let fallbackSrc = '';
let aspectClass = '';
let objectFitClass = '';

if (hasData) {
  basePath = `/images${data.path}`;
  availableWidths = data.variants.map(Number).sort((a: number, b: number) => a - b);
  defaultAspect = data.aspect;
  aspectRatio = defaultAspect.replace('x', '/');

  formats = [...data.format].sort((a, b) => (a === 'webp' ? -1 : b === 'webp' ? 1 : 0));

  if (!sizesAttr && breakpoints) {
    const { mobile = 320, tablet = mobile, desktop = tablet } = breakpoints;
    sizesAttr = `(max-width: 768px) ${mobile}px, (max-width: 1024px) ${tablet}px, ${desktop}px`;
  }
  if (!sizesAttr) {
    sizesAttr = '(max-width: 768px) 320px, (max-width: 1024px) 640px, 960px';
  }

  width1x = availableWidths.find(w => w >= targetWidth) ?? availableWidths[0];
  width2x = availableWidths.find(w => w >= width1x * 2) ?? width1x;

  imageBaseName = src.replace(/^.*[\/]/, '').replace(/\.[^.]+$/, '');
  fallbackSrc = `${basePath}${imageBaseName}-w${width1x}-a${defaultAspect}.${formats[0]}`;

  aspectClass = `a-${defaultAspect}`;
  objectFitClass = `of-${objectFit}`;
}


if (loading === 'eager' && hasData) {
  const format = formats[0];
  const buildSrc = (w: number) => `${basePath}${imageBaseName}-w${w}-a${defaultAspect}.${format}`;

  const mobileBP = breakpoints?.mobile ?? (typeof width === 'number' ? width : 320);
  const desktopBP = breakpoints?.desktop ?? mobileBP;

  const mWidth = availableWidths.find(w => w >= mobileBP) ?? availableWidths[0];
  const dWidth = availableWidths.find(w => w >= desktopBP) ?? mWidth;

  // ✅ If sizes is fixed → preload once
  if (desktopBP === mobileBP || (/^\d+px$/.test(sizesAttr ?? ''))) {
    registerPreloadImage({ src: buildSrc(mWidth) });
  } else {
    // ✅ Only preload each distinct width once
    registerPreloadImage({ src: buildSrc(mWidth), media: `(max-width: ${siteDefaults.breakpoints.mobileMax}px)` });
    if (dWidth !== mWidth) {
      registerPreloadImage({ src: buildSrc(dWidth), media: `(min-width: ${siteDefaults.breakpoints.desktopMin}px)` });
    }
  }
}




---

{!hasData ? (
  <div
    class={`flex ai-center jc-center bg-base-20 ${className}`}
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 1600 900"
      preserveAspectRatio="xMidYMid meet"      
      fill="#999"
    >
      <rect x="0" y="0" fill="#ccc" />
      <text x="50%" y="50%" text-anchor="middle" dominant-baseline="middle" font-size="10">
        {siteDefaults.siteName}
      </text>
    </svg>
  </div>
) : (
  <>
    {caption ? (
      <figure class={`block image-wrapper ${className}`}>
        <picture>
          {formats.map(format => (
            <source
              type={`image/${format === 'jpg' ? 'jpeg' : format}`}
              srcset={`${basePath}${imageBaseName}-w${width1x}-a${defaultAspect}.${format} 1x, ${basePath}${imageBaseName}-w${width2x}-a${defaultAspect}.${format} 2x`}
            />
          ))}
          <img
            src={fallbackSrc}
            srcset={`${basePath}${imageBaseName}-w${width1x}-a${defaultAspect}.${formats[0]} 1x, ${basePath}${imageBaseName}-w${width2x}-a${defaultAspect}.${formats[0]} 2x`}
            sizes={sizesAttr}
            width={width ?? width1x}
            height={height}
            alt={alt}
            title={title}
            loading={loading}
            decoding="async"
            fetchpriority={fetchPriority}
            class={`block w-full h-auto br ${imageClassName} ${aspectClass} ${objectFitClass}`}
          />
        </picture>
        <figcaption class="cg-small">{caption}</figcaption>
      </figure>
    ) : (
      <picture class={`block image-wrapper ${className}`}>
        {formats.map(format => (
          <source
            type={`image/${format === 'jpg' ? 'jpeg' : format}`}
            srcset={`${basePath}${imageBaseName}-w${width1x}-a${defaultAspect}.${format} 1x, ${basePath}${imageBaseName}-w${width2x}-a${defaultAspect}.${format} 2x`}
          />
        ))}
        <img
          src={fallbackSrc}
          srcset={`${basePath}${imageBaseName}-w${width1x}-a${defaultAspect}.${formats[0]} 1x, ${basePath}${imageBaseName}-w${width2x}-a${defaultAspect}.${formats[0]} 2x`}
          sizes={sizesAttr}
          width={width ?? width1x}
          height={height}
          alt={alt}
          title={title}
          loading={loading}
          decoding="async"
          fetchpriority={fetchPriority}
          class={`block w-full h-auto br ${imageClassName} ${aspectClass} ${objectFitClass}`}
        />
      </picture>
    )}
  </>
)}
