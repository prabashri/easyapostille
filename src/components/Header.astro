---
import Anchor from "./ui/Anchor.astro";
import Button from "./ui/Button.astro";
import { siteNav, primaryCTA, secondaryNavigation, headerStyle } from '../config/navigation'
import Logo from './navigation/Logo.astro'
import ThemeLightDark from './navigation/ThemeLightDark.astro';
import { Icon } from 'astro-icon/components';
import NavLinkItem from './navigation/NavLinkItem.astro';
import NavButton from './navigation/NavButton.astro';


const modeMap = {
  default: '',
  glassy: 'bg-transparent backdrop-blur',
  transparent: 'bg-transparent',
  'primary-light': 'bg-primary-light col-base-100',
  'primary-dark': 'bg-primary-dark col-base-00',
  custom: ''
}
 const modeMapNav = {
  default: '',
  glassy: 'big-bg-glass big-border-glass big-box-shadow',
  transparent: 'bg-transparent',
  'primary-light': 'bg-primary-light col-base-100',
  'primary-dark': 'bg-primary-dark col-base-00',
  custom: ''
}

const positionMap = {
  static: '',
  sticky: 'sticky top-0 z-100',
  fixed: 'fixed top-0 left-0 w-full z-100'
}

const separatorMap = {
  shadow: 'shadow-md',
  border: 'border-b border-gray-200',
  none: 'box-shadow-bottom'
}

const commonHeaderClasses = 'flex flex-col ai-center jc-center gap mi-auto pi-1 pb-05';
const headerClasses = [
  commonHeaderClasses,
  modeMap[headerStyle.mode],
  positionMap[headerStyle.position],
  separatorMap[headerStyle.separator ?? 'none'],
  headerStyle.width === 'sitewidth' ? 'w-site' : 'w-full',
]
.filter(Boolean)
.join(' ')

const navClasses = [
  modeMapNav[headerStyle.mode],
].filter(Boolean).join(' ');

const navOrder = ( (siteNav && siteNav.length > 0 ) && primaryCTA && primaryCTA.length > 0 ) ? "lg-w-full order-2 lg-order-3" : "order-2 lg-order-2";

---
<style id="header-style" is:global>
  /* Header styles */
  .header {
    color: aliceblue;
  }
  .main-nav {
    color: var(--base-100);
  }
  .secondary-nav {
   color: var(--base-100);
  }

</style>

<header class={headerClasses}>
  <div class="flex flex-row mx-w-site w-full relative gap-05 mi-auto ai-center jc-space-between lg-wrap md-wrap">
    {/* LOGO */}
    <div class="flex flex-row wrap gap-05 mx-w-site w-auto sm-w-full mb-0 ai-center jc-space-between">
      <Logo />
      {/* Mobile Menu Toggle */}
      <Button
        id="menu-toggle"
        label="Toggle Menu"
        className="menu-toggle sm-display-inherit h-40 w-40 mb-05 order-2"
        aria-label="Toggle Menu"
        type="button"
        variant="plain"
        ariaControls="main-nav main-nav-cta secondary-nav"
        ariaExpanded={false}		
        dataTargets="#main-nav,#main-nav-cta,#secondary-nav"
      >
        <Icon name="hamburger" id="menu-icon" class="block fill-base-100 w-1-5 h-1-5" />
        <Icon name="close" id="close-icon" class="display-none fill-base-100 w-1-5 h-1-5" />
      </Button>
    </div>

    {/* NAV ITEMS */}
    {siteNav.length > 0 && (
    <nav id="main-nav" class={`main-nav sm-bg scroll-container flex flex-row text-small ${navClasses} p-05 gap br-1 sm-br col-base-100 z-1000 big-display-inherit ${navOrder}`} itemscope itemtype="https://schema.org/SiteNavigationElement" aria-label="Primary site navigation">
      {/* Logo for Desktop */}
      <ul class="nav-list flex ai-center lg-w-full lg-jc-center no-bullets gap sm-flex-col sm-ai-start">
      {/* Loop through siteNav items */}
      {Array.isArray(siteNav) && siteNav.map((item, navIndex) => (           
          <li
            itemprop="name"
            class={`nav-item${item.type === 'dropdown' || item.type === 'mega' ? ' dropdown' : ''}${item.type === 'link' ? ' nav-link' : ''}${item.href === Astro.url.pathname ? ' active-page' : ''}`}
            data-id={`nav-item-${navIndex}`}
          >
            {/* Icon or Image */}
            {/* Link or Button based on item type */}
            {item.type === 'link' && (
              <NavLinkItem
                index={navIndex}
                item={item}
              />
            )}
            
            {item.type === 'dropdown' && item.content && (
              <NavButton 
                index={navIndex}
                item={item}
              /> 
              <div
                id={`dropdown-menu-${navIndex}`}
                role="menu"
                aria-hidden="true"
                class="dropdown-menu pb-1 bg-transparent static big-absolute top-70 z-1000"
              >
                <div class="bg-base-00 p-1 flex flex-col wrap gap br big-b-thin-primary-lighter">
                  {Array.isArray(item.content) && item.content.map((subItem, subItemIndex) => (
                    <NavLinkItem
                      item={subItem} index={subItemIndex}
                    />                        
                  ))}
                </div>
              </div>               
            )}

            {/* Mega Menu */}

            {item.type === 'mega' && Array.isArray(item.columns) && (
              <NavButton 
                index={navIndex}
                item={item}
              />                
            
              <div
                id={`dropdown-menu-${navIndex}`}
                role="menu"
                aria-hidden="true" 
                class="dropdown-menu mega-menu-panel pb-1 bg-col-ff static big-absolute top-70 left-0 z-1000 w-full"
              >
                <div class="bg-base-00 sm-bg p-05 br flex flex-row wrap w-full gap big-b-thin-primary-lighter">
                  {item.columns.map((col, colIndex) => (
                    <div data-id={`mega-col-${navIndex}-${colIndex}`} class="mega-column mn-w-250 flex flex-col flex-1 gap-05">
                      <h4 class="bold capitalize text-s mb-2">{col.title}</h4>
                      <ul>
                        {Array.isArray(col.items) && col.items.map((subItem, subItemIndex) => (
                          <li data-id={`mega-item-${navIndex}-${colIndex}-${subItemIndex}`} class="mb-1">
                            <NavLinkItem
                              item={subItem}
                            />
                          </li>
                        ))}
                      </ul>
                    </div>
                  ))}
                </div>
              </div>                
            )}
          </li>
        ))}
      </ul>
    </nav>
    )}
    {/* Primary CTA Button */}
    {primaryCTA.length > 0 && ( 
      <div id="main-nav-cta" class="flex br sm-bg sm-w-full p-05 ai-center gap-05 order-3 lg-order-2" aria-label="Primary Call to Action">
        {/* Theme Toggle */}
        <ThemeLightDark />
        {/* Loop through primaryCTA items */}
        {primaryCTA.map((cta) => (
          <Anchor
            href={cta.href}
            title={cta.title || cta.label}
            variant={cta.variant || 'primary'}
            ariaLabel={cta.ariaLabel || cta.label}
            className={cta.icon ? 'flex ai-center ac-center gap-05' : ''}
          >
            {cta.icon && <img src={cta.icon} alt={cta.altText || cta.label} width="24" class="w-20 inline" />}
            {cta.label}
          </Anchor>
        ))}

      </div>
    )}
     
   
    
  </div>
  {/* SECONDARY NAVIGATION (Optional) */}
  {secondaryNavigation.length > 0 && (
    <nav id="secondary-nav" class="secondary-nav sm-bg flex flex-row text-xs p-05 br gap z-10 mx-w-site w-full desktop-box-shadow-bottom big-display-inherit" aria-label="Secondary site navigation" itemscope itemtype="https://schema.org/SiteNavigationElement">
      {/* Loop through secondaryNavigation items */}
      <ul class="nav-list flex ai-center no-bullets gap sm-flex-col sm-ai-start">
        {Array.isArray(secondaryNavigation) && secondaryNavigation.map((item, navIndex) => (
          <li
            itemprop="name"
            class={`sec-nav-item${item.type === 'dropdown' || item.type === 'mega' ? ' dropdown' : ''}${item.type === 'link' ? ' nav-link' : ''}${item.href === Astro.url.pathname ? ' active-page' : ''}`}
            data-id={`sec-nav-item-${navIndex}`}
          >
              {/* Icon or Image */}
              {/* Link or Button based on item type */}
              {( !item.type || item.type === 'link' ) && (
                <NavLinkItem
                  index={navIndex}
                  item={item}
                />
              )}
             
              {item.type === 'dropdown' && item.content && (
                <NavButton 
                  index={navIndex}
                  item={item}
                /> 
                <div
                  id={`dropdown-menu-${navIndex}`}
                  role="menu"
                  aria-hidden="true"
                  class="dropdown-menu pb-1 bg-transparent static big-absolute top-70 z-1000"
                >
                  <div class="bg-base-90 col-base-00 p-1 flex flex-col wrap gap br">
                    {Array.isArray(item.content) && item.content.map((subItem, subItemIndex) => (
                      <NavLinkItem
                        item={subItem} index={subItemIndex}
                      />                        
                    ))}
                  </div>
                </div>               
              )}

              {/* Mega Menu */}

              {item.type === 'mega' && Array.isArray(item.columns) && (
                <NavButton 
                  index={navIndex}
                  item={item}
                />                
             
                <div
                  id={`dropdown-menu-${navIndex}`}
                  role="menu"
                  aria-hidden="true"
                  class="dropdown-menu mega-menu-panel pb-1 bg-col-ff static big-absolute top-70 left-0 z-1000 w-full"
                >
                  <div class="bg-base-00 sm-bg p-1 br flex flex-row wrap w-full gap big-b-thin-primary-lighter">
                    {item.columns.map((col, colIndex) => (
                      <div data-id={`mega-col-${navIndex}-${colIndex}`} class="mega-column mn-w-250 flex flex-col flex-1 gap-05">
                        <h4 class="bold capitalize text-s mb-2">{col.title}</h4>
                        <ul>
                          {Array.isArray(col.items) && col.items.map((subItem, subItemIndex) => (
                            <li data-id={`mega-item-${navIndex}-${colIndex}-${subItemIndex}`} class="mb-1">
                              <NavLinkItem
                                item={subItem}
                              />
                            </li>
                          ))}
                        </ul>
                      </div>
                    ))}
                  </div>
                </div>                
              )}
            </li>
        ))}
      </ul>
    </nav>
  )}
</header>
<script id="header-script" type="module">
  'use strict';
(() => {
  
  document.addEventListener('DOMContentLoaded', () => {
    const toggleBtn = document.getElementById('menu-toggle');
	
    const targetIds = ['main-nav', 'main-nav-cta', 'secondary-nav'];

    const hamburgerIcon = document.getElementById('menu-icon');
    const closeIcon = document.getElementById('close-icon');

    const selector = toggleBtn.getAttribute('data-targets');
	
    const targets = selector
    ? selector.split(',').map((s) => document.querySelector(s.trim())).filter(Boolean)
    : [];

    const navItems = document.querySelectorAll('.nav-item.dropdown');
    const activeClass = 'dropdown-active';
    let isDesktop = window.matchMedia('(min-width: 768px)').matches;

    // Cache dropdown buttons and menus
    navItems.forEach(item => {
      item._button = item.querySelector('button[data-action]');
      item._menu = item.querySelector('.dropdown-menu');
    });

    // Toggle mobile menu (hamburger)
     toggleBtn.addEventListener('click', () => {
										console.log('Toggle button clicked');
      const isOpen = targets[0]?.classList.contains('is-open');
      const willOpen = !isOpen;

      targets.forEach((el) => el.classList.toggle('is-open', willOpen));
      toggleBtn.setAttribute('aria-expanded', String(willOpen));
      hamburgerIcon?.classList.toggle('display-none', willOpen);
      closeIcon?.classList.toggle('display-none', !willOpen);
    });


    // Dropdown open/close logic
    const openMenu = (item) => {
      item.classList.add(activeClass);
      item._menu?.setAttribute('aria-hidden', 'false');
      item._button?.setAttribute('aria-expanded', 'true');
    };

    const closeMenu = (item) => {
      item.classList.remove(activeClass);
      item._menu?.setAttribute('aria-hidden', 'true');
      item._button?.setAttribute('aria-expanded', 'false');
    };

    const closeAllMenusExcept = (exceptItem) => {
      navItems.forEach(item => {
        if (item !== exceptItem) closeMenu(item);
      });
    };

    const setupNavBehavior = () => {
      navItems.forEach(item => {
        const button = item._button;
        const menu = item._menu;
        if (!button || !menu) return;

        // Cleanup previous listeners
        item.removeEventListener('mouseenter', item._hoverIn);
        item.removeEventListener('mouseleave', item._hoverOut);
        button.onclick = null;

        if (isDesktop) {
          // Hover behavior
          item._hoverIn = () => openMenu(item);
          item._hoverOut = () => closeMenu(item);
          item.addEventListener('mouseenter', item._hoverIn);
          item.addEventListener('mouseleave', item._hoverOut);

          // Click toggles
          button.onclick = (e) => {
            e.preventDefault();
            const isOpen = item.classList.contains(activeClass);
            if (isOpen) {
              closeMenu(item);
            } else {
              closeAllMenusExcept(item);
              openMenu(item);
            }
          };

          // Focus management
          button.addEventListener('focusout', (e) => {
            setTimeout(() => {
              if (!item.contains(document.activeElement)) closeMenu(item);
            }, 100);
          });

        } else {
          // Mobile click-only toggle
          button.onclick = (e) => {
            e.preventDefault();
            const isOpen = item.classList.contains(activeClass);
            if (isOpen) {
              closeMenu(item);
            } else {
              closeAllMenusExcept(item);
              openMenu(item);
            }
          };
        }
      });
    };

    // Initial setup
    setupNavBehavior();

    // Throttled resize listener
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        const newIsDesktop = window.matchMedia('(min-width: 768px)').matches;
        if (newIsDesktop !== isDesktop) {
          isDesktop = newIsDesktop;
          setupNavBehavior();
        }
      }, 150);
    });

    // Close all dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      navItems.forEach(item => {
        if (!item.contains(e.target)) closeMenu(item);
      });
    });
  });
})();
</script>