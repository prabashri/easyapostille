---
// src/components/navigation/ThemeLightDark.astro
import { Icon } from 'astro-icon/components';
import searchIndex from '/public/search-index.json';
import manifest from '../../data/assets-manifest.json'; // no destructuring here

const searchIndexPath = manifest.json?.['search-index']?.file || '';
const searchScriptPath = manifest.js?.['search']?.file || '';

---
{ (searchIndexPath && searchScriptPath) && (
  <div id="global-search-button" class="flex flex-row relative h-2-0 w-2-0 mb-1 as-f-start">
    <!-- Trigger -->
    <button id="global-search-button" aria-label="Open search" class="search-trigger">üîç</button>

    <!-- Modal -->
    <div id="search-modal" class="search-modal hidden" role="dialog" aria-modal="true" aria-label="Site search dialog">
      <div class="search-modal-content" tabindex="-1">
        <button id="close-search-modal" aria-label="Close search">‚úñ</button>
        <form id="search-modal-form" role="search">
          <input id="search-modal-input" type="search" placeholder="Search..." autocomplete="off" />
        </form>
        <ul id="search-modal-results" class="search-results"></ul>
      </div>
    </div>
  </div>
  )}  
<div class="theme-toggle flex flex-row relative h-2-0 w-2-0 mb-1 as-f-start"> 

    <!-- Trigger Button -->
    <button id="theme-button" aria-haspopup="true" aria-expanded="false"
      class="round box-shadow-glow transition p-02">
      <Icon name="system" class="w-1-5 h-1-5" />
      <Icon name="light" class="w-1-5 h-1-5 display-none" />
      <Icon name="moon" class="w-1-5 h-1-5 display-none" />
    </button>

    <!-- Dropdown -->
    <div id="theme-menu"
      class="absolute br border bg-base-00 col-base-100 mb-05 box-shadow display-none right-0 p-05 z-1000">
      <button class="theme-option flex ai-center gap full-width text-left mx-w-320 mn-w-160 ac-center pi-05 mb-05 mi-02 bg-transparent hover-bg-primary-light col-inherit hover-col-base-00 full-width jc-start"
        data-theme="system">
        <Icon name="system" class="w-1-5 h-1-5" />
        <span>OS Default</span>
      </button>
      <button class="theme-option flex ai-center gap full-width text-left mx-w-320 mn-w-160 ac-center pi-05 mb-05 mi-02 bg-transparent hover-bg-primary-light col-inherit hover-col-base-00 full-width jc-start"
        data-theme="light">
        <Icon name="light" class="w-1-5 h-1-5" />
        <span>Light</span>
      </button>
      <button class="theme-option flex ai-center gap full-width text-left mx-w-320 mn-w-160 ac-center pi-05 mb-05 mi-02 bg-transparent hover-bg-primary-light col-inherit hover-col-base-00 full-width jc-start"
        data-theme="dark">
        <Icon name="moon" class="w-1-5 h-1-5" />
        <span>Dark</span>
      </button>
    </div>
  </div>
  <style>
    .search-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.75);
  display: flex;
  justify-content: center;
  align-items: start;
  padding-top: 10vh;
  z-index: 1000;
}
.search-modal.hidden {
  display: none;
}
.search-modal-content {
  background: white;
  max-width: 700px;
  width: 90%;
  border-radius: 8px;
  padding: 1rem;
}
.search-results li {
  padding: 0.5rem;
  border-bottom: 1px solid #eee;
}

  </style>
 <script id="theme-script" type="module">
(() => {
  document.addEventListener('DOMContentLoaded', () => {
    const button = document.getElementById('theme-button');
    const menu = document.getElementById('theme-menu');
    const options = document.querySelectorAll('.theme-option');

    const iconSystem = document.querySelector('svg[data-icon="system"]');
    const iconLight = document.querySelector('svg[data-icon="light"]');
    const iconDark = document.querySelector('svg[data-icon="moon"]');

    const showIcon = (theme) => {
      if (!iconSystem || !iconLight || !iconDark) return;

      iconSystem.classList.add('display-none');
      iconLight.classList.add('display-none');
      iconDark.classList.add('display-none');

      if (theme === 'light') {
        iconLight.classList.remove('display-none');
      } else if (theme === 'dark') {
        iconDark.classList.remove('display-none');
      } else {
        iconSystem.classList.remove('display-none');
      }
    };

    const applyTheme = (theme) => {
      if (theme === 'light' || theme === 'dark') {
        document.documentElement.setAttribute('data-theme', theme);
        showIcon(theme);
      } else {
        // fallback to system preference
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const fallbackTheme = prefersDark ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', fallbackTheme);
        showIcon('system');
      }
    };

    const setTheme = (theme) => {
      localStorage.setItem('theme', theme);
      applyTheme(theme);
    };

    const getStoredTheme = () => {
      const stored = localStorage.getItem('theme');
      if (stored === 'light' || stored === 'dark' || stored === 'system') {
        return stored;
      }
      return 'light'; // force fallback to light if invalid
    };

    const toggleMenu = () => {
      const isExpanded = button?.getAttribute('aria-expanded') === 'true';
      button?.setAttribute('aria-expanded', String(!isExpanded));
      menu?.classList.toggle('display-none', isExpanded);
    };

    const closeMenu = () => {
      menu?.classList.add('display-none');
      button?.setAttribute('aria-expanded', 'false');
    };

    // Event: Toggle menu
    button?.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleMenu();
    });

    // Event: Close menu on outside click
    document.addEventListener('click', (e) => {
      if (!menu?.contains(e.target) && !button?.contains(e.target)) {
        closeMenu();
      }
    });

    // Event: Theme change
    options.forEach((option) => {
      option.addEventListener('click', () => {
        const selected = option.getAttribute('data-theme');
        if (selected) setTheme(selected);
        closeMenu();
      });
    });

    // Apply theme on load
    applyTheme(getStoredTheme());

    // Listen for system preference changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
      if (getStoredTheme() === 'system') {
        applyTheme('system');
      }
    });
  });
})();
</script>


{searchIndexPath && searchScriptPath && (
  
  <script
    type="module"
    src={searchScriptPath}
    data-search-index={searchIndexPath}
  ></script>
)}
