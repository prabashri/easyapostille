---
import Button from "@/components/ui/Button.astro";
import Anchor from "@/components/ui/Anchor.astro";
import { siteFunctions } from '@/config/siteFunctions';

const euOnly  = siteFunctions.consent?.euOnly ?? true;
const timerMs = siteFunctions.consent?.autograntMs ?? '';
const timer   = Math.round((Number(timerMs) || 120000) / 1000);

const POS = {
  CENTER: 'center',
  BOTTOM_CENTERED: 'bottom-centered',
  BOTTOM_RIGHT: 'bottom-right',
  BOTTOM_LEFT: 'bottom-left',
};

const rawPos = (siteFunctions.consent?.position ?? POS.CENTER);
const mapAlias = (val: unknown) => {
  const v = String(val ?? '').toLowerCase().trim();
  if (v === 'center' || v === 'centre') return POS.CENTER;
  if (v === 'bottom' || v === 'bottomcentered' || v === 'bottom-center' || v === 'bottom-centre') return POS.BOTTOM_CENTERED;
  if (v === 'bottomright' || v === 'bottom-right') return POS.BOTTOM_RIGHT;
  if (v === 'bottomleft'  || v === 'bottom-left')  return POS.BOTTOM_LEFT;
  return POS.CENTER;
};
const placement = mapAlias(rawPos);
---
<!-- Launcher -->
<button
  id="consent-toggler"
  class="consent-toggler fixed left-0 bottom-0 z-1000 inline-flex ai-center jc-center w-2-5 h-2-5 br bg border box-shadow pointer"
  aria-label="Privacy & cookie settings"
  title="Privacy & cookie settings"
>
  <img src="/icons/privacy-shield.svg" alt="" width="20" height="20" aria-hidden="true" />
</button>

<!-- Modal / Bar -->
<div
  id="consent-modal"
  class="consent-modal is-hidden fixed inset-0 z-1000 overscroll-contain gap-0"
  role="dialog"
  aria-modal="true"
  aria-labelledby="consent-title"
  data-pos={placement}         
>
  <!-- Overlay (shown only in center mode via CSS below) -->
  <div id="consent-overlay" class="consent-overlay pointer-events-auto absolute inset-0 z-0" aria-hidden="true"></div>

  <!-- Sheet -->

  <div class="consent-sheet bg col-text border br box-shadow mx-w-featured w-95-0 mn-h-230 mx-h-80vh overflow-hidden pointer-events-auto z-1" role="document">
    <div class="consent-header flex ai-center jc-space-between p-1 b-bottom">
      <div class="consent-title-wrap flex ai-center gap-05">
        <img class="consent-title-icon opacity-90 w-2-0 h-2-0" src="/icons/privacy-shield.svg" width="20" height="20" alt="" aria-hidden="true" />
        <h3 id="consent-title" class="consent-title m-0 text-base lh-1-2">Cookie preferences</h3>
      </div>

      <button id="consent-close" class="consent-close bg-transparent border w-2-0 h-2-0 br pointer" aria-label="Close dialog" title="Close">x</button>
    </div>

    <div class="consent-body overflow-auto pi-05 pb-1 overscroll-contain">
      <p class="consent-intro m-0 mb-05 text-sm">
        We use cookies to keep the site secure and functional, improve services, and—if you allow—measure usage and show relevant ads.
        We and partners (e.g., Google) may process data for ads and analytics insights.
        See our <Anchor href="/privacy-policy/">Privacy Policy</Anchor>, <Anchor href="/cookie-policy/">Cookie Policy</Anchor>,
        and Google's <a href="https://policies.google.com/technologies/partner-sites" target="_blank" rel="nofollow noopener">Privacy &amp; Terms</a>.
      </p>

      <form id="consent-form" class="consent-form flex flex-col gap-05" action="#" method="post" novalidate>
        <fieldset class="consent-group m-0 p-0 border-0">
          <legend class="consent-group-title">Your choices</legend>

          <div class="consent-row flex ai-f-start jc-space-between gap-05 pi-05 pb-0">            
            <label for="cb-essential-ui" class="consent-row-main flex flex-col gap-02">
              <span class="consent-row-label bold">Essential</span>
              <span class="consent-row-note text-sm col-base-50">Security, network, and core features.</span>
            </label>
            <input id="cb-essential-ui" type="checkbox" class="w-1-5 h-1-5 m-05" checked disabled />
          </div>

          <div class="consent-row flex ai-f-start jc-space-between gap-05 pi-05 pb-0 b-top-dashed">          
            <label for="cb-ads-ui" class="consent-row-main flex flex-col gap-02">
              <span class="consent-row-label bold">Advertising (basic)</span>
              <span class="consent-row-note text-sm col-base-50">Shows ads to keep access free. No personalization unless allowed below.</span>
            </label>
            <input id="cb-ads-ui" type="checkbox" class="w-1-5 h-1-5 m-05" checked disabled />
            <input id="cb-ads" type="checkbox" class="display-none none is-hidden hide" checked />
          </div>

          <div class="consent-row flex ai-f-start jc-space-between gap-05 pi-05 pb-0 b-top-dashed">
            <label for="cb-personalized" class="consent-row-main flex flex-col gap-02">
              <span class="consent-row-label bold">Advertising (personalized)</span>
              <span class="consent-row-note text-sm col-base-50">Use activity to tailor ads via partners like Google.</span>
            </label>
            <input id="cb-personalized" type="checkbox" class="w-1-5 h-1-5 m-05" />
          </div>

          <div class="consent-row flex ai-f-start jc-space-between gap-05 pi-05 pb-0 b-top-dashed">
            <label for="cb-analytics" class="consent-row-main flex flex-col gap-02">
              <span class="consent-row-label bold">Analytics</span>
              <span class="consent-row-note text-sm col-base-50">Anonymous stats to understand usage and improve quality.</span>
            </label>
            <input id="cb-analytics" type="checkbox" class="w-1-5 h-1-5 m-05" />
          </div>
        </fieldset>

        {euOnly && (
          <p class="consent-footnote mi-05 col-base-50 text-sm italic">
            You can change your choices any time. After <span id="consent-timer-seconds">{timer}</span> seconds,
            default settings may apply.
          </p>
        )}

        <div class="consent-actions flex gap-05 flex-wrap mt-05">
          <Button id="consent-accept-all" variant="primary" type="button" label="Accept all">Accept all</Button>
          <Button id="consent-deny-all"   variant="secondary" type="button" label="Deny all">Deny all</Button>
          <Button id="consent-save"       variant="primary" type="button" label="Save choices">Save choices</Button>
        </div>
      </form>
    </div>
  </div>
</div>